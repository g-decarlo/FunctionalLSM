library(dplyr)
download = FALSE
dir_path = "GHCN/"
if(download)
{
download.file("https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/ghcnd-countries.txt", destfile = "ghcnd-countries.txt")
download.file("https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/ghcnd-inventory.txt", destfile = "ghcnd-inventory.txt")
download.file("https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/ghcnd-stations.txt", destfile = "ghcnd-stations.txt")
download.file("https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt", destfile = "readme.txt")
download.file("https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/ghcnd_all.tar.gz", destfile = "ghcnd-all.tar.gz")
stnscsv = paste0(dir_path,"stations.csv")
typedcols = c( "A11", "F9", "F10", "F7", "X1","A2",
"X1","A30", "X1", "A3", "X1", "A3", "X1", "A5" )
stns = read.fortran(paste0(dir_path,"ghcnd-stations.txt"),
typedcols,
comment.char="")
hdrs = c("ID", "LAT", "LON", "ELEV", "ST", "NAME","GSN", "HCN", "WMOID")
names(stns) = hdrs
write.csv(stns,stnscsv)
inventorycsv = paste0(dir_path,"inventory.csv")
invcols = c( "A11", "X1", "F8", "X1", "F9", "X1","A4",
"X1","I4", "X1", "I4" )
inv = read.fortran(paste0(dir_path,"ghcnd-inventory.txt"),
invcols,
comment.char="")
invhdrs = c("ID", "LAT", "LON", "ELEM" , "FIRST", "LAST")
names(inv) = invhdrs
write.csv(inv,inventorycsv)
}
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
stns = fread(stnscsv)
us_inv_prcp = inv %>% filter( substr(ID,1,2) == "US", FIRST <= 2017, ELEM == "PRCP",  LAST >= 2018)
us_st_prcp = stns %>% filter(substr(ID,1,2) == "US")
us_infos = us_inv_prcp %>% left_join(us_st_prcp %>% select(ID,ELEV,ST,NAME),by = c("ID" = "ID")) %>% filter(!(ST %in% islands))
numFiles = length(us_infos$ID)
dirname = paste0(dir_path,"ghcnd_all/")
rm(list = ls())
library(data.table)
library(dplyr)
download = FALSE
dir_path = "GHCN/"
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
inv = fread(inventory.csv)
inv = fread(inventory)
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
inv = fread(inventorycsv)
setwd("C:/Users/Giacomo/Desktop/Tesi/GHCN")
inv = fread(inventorycsv)
inv = fread(inventory.csv)
inv = fread(inventory)
library(data.table)
library(dplyr)
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
stns = fread(stnscsv)
us_inv_prcp = inv %>% filter( substr(ID,1,2) == "US", FIRST <= 2017, ELEM == "PRCP",  LAST >= 2018)
rm(list = ls())
library(data.table)
download = TRUE
dir_path = "GHCN/"
library(dplyr)
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
setwd("C:/Users/Giacomo/Desktop/Tesi")
library(dplyr)
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
inv = fread(inventorycsv)
stns = fread(stnscsv)
us_inv_prcp = inv %>% filter( substr(ID,1,2) == "US", FIRST <= 2017, ELEM == "PRCP",  LAST >= 2018)
us_st_prcp = stns %>% filter(substr(ID,1,2) == "US")
help(fread)
inv = fread(inventorycsv)
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
library(dplyr)
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
library(dplyr)
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
inv = fread(inventorycsv)
stnscsv = paste0(dir_path,"stations.csv")
typedcols = c( "A11", "F9", "F10", "F7", "X1","A2",
"X1","A30", "X1", "A3", "X1", "A3", "X1", "A5" )
stns = read.fortran(paste0(dir_path,"ghcnd-stations.txt"),
typedcols,
comment.char="")
hdrs = c("ID", "LAT", "LON", "ELEV", "ST", "NAME","GSN", "HCN", "WMOID")
names(stns) = hdrs
write.csv(stns,stnscsv)
inventorycsv = paste0(dir_path,"inventory.csv")
invcols = c( "A11", "X1", "F8", "X1", "F9", "X1","A4",
"X1","I4", "X1", "I4" )
inv = read.fortran(paste0(dir_path,"ghcnd-inventory.txt"),
invcols,
comment.char="")
invhdrs = c("ID", "LAT", "LON", "ELEM" , "FIRST", "LAST")
names(inv) = invhdrs
write.csv(inv,inventorycsv)
library(dplyr)
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
stns = fread(stnscsv)
us_inv_prcp = inv %>% filter( substr(ID,1,2) == "US", FIRST <= 2017, ELEM == "PRCP",  LAST >= 2018)
us_st_prcp = stns %>% filter(substr(ID,1,2) == "US")
us_infos = us_inv_prcp %>% left_join(us_st_prcp %>% select(ID,ELEV,ST,NAME),by = c("ID" = "ID")) %>% filter(!(ST %in% islands))
numFiles = length(us_infos$ID)
dirname = paste0(dir_path,"ghcnd_all/")
library(foreach)
library(doParallel)
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
stopCluster(cl)
warnings()
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
i=1
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
library(foreach)
library(doParallel)
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
i=1
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
library(foreach)
library(doParallel)
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
i=1
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
stopCluster(cl)
library(foreach)
library(doParallel)
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
i=1
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
warnings()
warnings()
numFiles
numFiles = length(us_infos$ID)
length(us_infos$ID)
stopcluster(cl)
stopCluster(cl)
length(us_infos$ID)
numFiles = length(us_infos$ID)
3+2
x
x=3
x
x
x
print(x)
sink()
x
x+2
sink()
dir_path = "GHCN/"
if(download)
download = FALSE
dir_path = "GHCN/"
}
rm(list = ls())
library(data.table)
download = FALSE
dir_path = "GHCN/"
inventorycsv = paste0(dir_path,"inventory.csv")
stnscsv = paste0(dir_path,"stations.csv")
library(dplyr)
stnscsv = paste0(dir_path,"stations.csv")
inventorycsv = paste0(dir_path,"inventory.csv")
islands = c("AK","HI","PI","UM")
inv = fread(inventorycsv)
stns = fread(stnscsv)
us_inv_prcp = inv %>% filter( substr(ID,1,2) == "US", FIRST <= 2017, ELEM == "PRCP",  LAST >= 2018)
us_st_prcp = stns %>% filter(substr(ID,1,2) == "US")
us_infos = us_inv_prcp %>% left_join(us_st_prcp %>% select(ID,ELEV,ST,NAME),by = c("ID" = "ID")) %>% filter(!(ST %in% islands))
numFiles = length(us_infos$ID)
dirname = paste0(dir_path,"ghcnd_all/")
numFiles
us_infos$ID[i]
View(us_infos)
numFiles = length(us_infos$ID)
dirname = paste0(dir_path,"ghcnd_all/")
library(foreach)
library(doParallel)
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
i=1
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
dirname = paste0(dir_path,"ghcnd_all/ghcnd_all/")
library(foreach)
library(doParallel)
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
i=1
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
stopCluster(cl)
dirname = paste0(dir_path,"ghcnd-all/ghcnd_all/")
library(foreach)
library(doParallel)
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
i=1
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
stopCluster(cl)
station_list = list()
good = 0
for ( i in 1:numFiles) ## Recupero i dati di Risser e Calder (Spererei)
{
filename = paste0(dirname, us_infos$ID[i], ".csv")
df = fread(filename)
df = df %>% filter((year == 2017 & month >= 10) | (year == 2018 & month <= 9))
if(nrow(df) == 12 & sum(is.na(df)) <= 7){
good = good + 1
station_list[[good]] = df
print(good)
}
}
i=1
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
library(foreach)
library(doParallel)
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
i=1
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
stopCluster(cl)
station_list = list()
good = 0
for ( i in 1:numFiles) ## Recupero i dati di Risser e Calder (Spererei)
{
filename = paste0(dirname, us_infos$ID[i], ".csv")
df = fread(filename)
df = df %>% filter((year == 2017 & month >= 10) | (year == 2018 & month <= 9))
if(nrow(df) == 12 & sum(is.na(df)) <= 7){
good = good + 1
station_list[[good]] = df
print(good)
}
}
library(foreach)
library(doParallel)
cl = makePSOCKcluster(16)
registerDoParallel(cl)
writeLines(c(""), paste0(dir_path,"/log.txt"))
foreach (i = 1:numFiles,.packages = c("tidyverse","data.table")) %dopar% {
sink(paste0(dir_path,"/log.txt"),append = T)
infile = paste0(dirname, us_infos$ID[i], ".dly")
outfile = paste0(dirname, us_infos$ID[i], ".csv")
cols = c( "A11", "I4", "I2", "A4",
rep( c( "I5", "A1", "A1", "A1"), 31) )
df = read.fortran(infile, cols, na.strings="-9999")
tmp = c("Val","xxM","xxQ","xxS") # xx so we can ditch them later
vhdrs = paste(   rep(tmp,31),   rep(1:31,each=4), sep="")
hdrs = c("ID", "year", "month", "element", vhdrs)
names(df) = hdrs
df = df %>% filter(year <= 2018 & year >= 2017 & element == "PRCP" )
df_out = dplyr::select(df, -matches("xx*")) # get rid of M, Q, S
fwrite(df_out, outfile)
print(i)
sink()
}
stopCluster(cl)
station_list = list()
good = 0
for ( i in 1:numFiles) ## Recupero i dati di Risser e Calder (Spererei)
{
filename = paste0(dirname, us_infos$ID[i], ".csv")
df = fread(filename)
df = df %>% filter((year == 2017 & month >= 10) | (year == 2018 & month <= 9))
if(nrow(df) == 12 & sum(is.na(df)) <= 7){
good = good + 1
station_list[[good]] = df
print(good)
}
}
df
